<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Album - Fotobook</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <%= csrf_meta_tags %>
</head>
<body>
  <!-- Navigation -->
  <%= render 'shared/navigation' %>

  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow">
          <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="fas fa-edit me-2"></i>Edit Album
            </h4>
            <%= button_to @album, 
                method: :delete, 
                class: 'btn btn-danger btn-sm', 
                data: { 
                  confirm: 'Are you sure you want to delete this album? This action cannot be undone and all images will be permanently removed.',
                  turbo_confirm: 'Are you sure you want to delete this album? This action cannot be undone and all images will be permanently removed.'
                } do %>
              <i class="fas fa-trash me-1"></i>Delete Album
            <% end %>
          </div>
          <div class="card-body">
            <%= form_with(model: @album, local: true, class: 'needs-validation', novalidate: true, html: { multipart: true }) do |form| %>
              <% if @album.errors.any? %>
                <div class="alert alert-danger">
                  <h5><i class="fas fa-exclamation-triangle me-2"></i><%= pluralize(@album.errors.count, "error") %> prohibited this album from being saved:</h5>
                  <ul>
                    <% @album.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <div class="mb-3">
                <%= form.label :title, class: 'form-label fw-bold' %>
                <%= form.text_field :title, 
                    class: 'form-control', 
                    placeholder: 'Enter album title (max 140 characters)', 
                    maxlength: 140, 
                    required: true %>
                <div class="form-text">Maximum 140 characters</div>
              </div>

              <div class="mb-3">
                <%= form.label :description, class: 'form-label fw-bold' %>
                <%= form.text_area :description, 
                    class: 'form-control', 
                    placeholder: 'Enter album description (max 300 characters)', 
                    maxlength: 300, 
                    rows: 3, 
                    required: true %>
                <div class="form-text">Maximum 300 characters</div>
              </div>

              <div class="mb-3">
                <%= form.label :sharing_mode, class: 'form-label fw-bold' %>
                <%= form.select :sharing_mode, 
                    options_for_select([
                      ['Public - Everyone can see', 'public'], 
                      ['Private - Only you can see', 'private']
                    ], @album.sharing_mode), 
                    {}, 
                    class: 'form-select', 
                    required: true %>
              </div>

              <!-- Current Album Images -->
              <% if @album.photos.any? %>
                <div class="mb-4">
                  <h6 class="fw-bold">
                    <i class="fas fa-images me-2"></i>Current Album Images
                  </h6>
                  <div class="row">
                    <% @album.photos.each do |photo| %>
                      <div class="col-md-3 mb-2">
                        <div class="position-relative">
                          <% if photo.image.present? %>
                            <%= image_tag photo.image.url, 
                                class: 'img-thumbnail', 
                                style: 'width: 100px; height: 100px; object-fit: cover;' %>
                          <% else %>
                            <%= image_tag 'logo_login.png', 
                                class: 'img-thumbnail', 
                                style: 'width: 100px; height: 100px; object-fit: cover;' %>
                          <% end %>
                          <div class="small text-muted mt-1"><%= photo.title %></div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <!-- Add More Images Section -->
              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="fas fa-plus me-2"></i>Add More Images
                </label>
                <div class="upload-area border-2 border-dashed border-secondary rounded p-4 text-center" id="uploadArea">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">Drag & Drop images here</h5>
                  <p class="text-muted mb-3">or click to browse files</p>
                  <input type="file" 
                         id="imageInput" 
                         name="album[images][]" 
                         multiple 
                         accept="image/jpeg,image/png,image/gif"
                         class="d-none"
                         data-max-size="5242880"
                         data-max-count="25">
                  <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                    <i class="fas fa-folder-open me-2"></i>Choose Files
                  </button>
                  <div class="mt-2">
                    <small class="text-muted">
                      Accepted formats: JPEG, PNG, GIF | Max size: 5MB per image | Max 25 images total
                    </small>
                  </div>
                </div>

                <!-- Image Preview -->
                <div id="imagePreview" class="row mt-3" style="display: none;">
                  <h6 class="mb-3">New Images to Add:</h6>
                  <div id="previewContainer" class="row"></div>
                </div>
              </div>

              <!-- Existing Photos Selection -->
              <div class="mt-4">
                <h6 class="fw-bold">
                  <i class="fas fa-images me-2"></i>Or Select from Existing Photos
                </h6>
                <div class="row">
                  <% current_user.photos.each do |photo| %>
                    <div class="col-md-3 mb-2">
                      <div class="form-check">
                        <%= form.check_box :photo_ids, 
                            { multiple: true, class: 'form-check-input' }, 
                            photo.id, 
                            nil %>
                        <%= form.label "photo_ids_#{photo.id}", class: 'form-check-label' do %>
                          <% if photo.image.present? %>
                            <%= image_tag photo.image.url, 
                                class: 'img-thumbnail', 
                                style: 'width: 100px; height: 100px; object-fit: cover;' %>
                          <% else %>
                            <%= image_tag 'logo_login.png', 
                                class: 'img-thumbnail', 
                                style: 'width: 100px; height: 100px; object-fit: cover;' %>
                          <% end %>
                          <div class="small text-muted mt-1"><%= photo.title %></div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="d-flex justify-content-between">
                <%= link_to :back, class: 'btn btn-secondary' do %>
                  <i class="fas fa-arrow-left me-2"></i>Back
                <% end %>
                <%= form.submit 'Update Album', class: 'btn btn-primary' do %>
                  <i class="fas fa-save me-2"></i>Update Album
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const uploadArea = document.getElementById('uploadArea');
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const previewContainer = document.getElementById('previewContainer');
      const maxSize = 5 * 1024 * 1024; // 5MB
      const maxCount = 25;
      let selectedFiles = [];

      // Drag and drop functionality
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary');
      });

      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
      });

      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });

      // File input change
      imageInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
      });

      function handleFiles(files) {
        const validFiles = files.filter(file => {
          // Check file type
          if (!file.type.match('image.*')) {
            alert(`File ${file.name} is not an image.`);
            return false;
          }

          // Check file size
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return false;
          }

          // Check total count
          if (selectedFiles.length + 1 > maxCount) {
            alert(`Maximum ${maxCount} images allowed.`);
            return false;
          }

          return true;
        });

        selectedFiles = selectedFiles.concat(validFiles);
        updatePreview();
        updateFileInput();
      }

      function updatePreview() {
        if (selectedFiles.length === 0) {
          imagePreview.style.display = 'none';
          return;
        }

        imagePreview.style.display = 'block';
        previewContainer.innerHTML = '';

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const col = document.createElement('div');
            col.className = 'col-md-3 mb-2';
            col.innerHTML = `
              <div class="position-relative">
                <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                        onclick="removeFile(${index})" style="font-size: 0.5rem;">
                  <i class="fas fa-times"></i>
                </button>
                <div class="small text-muted mt-1">${file.name}</div>
              </div>
            `;
            previewContainer.appendChild(col);
          };
          reader.readAsDataURL(file);
        });
      }

      function updateFileInput() {
        // Create a new FileList-like object
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;
      }

      window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updatePreview();
        updateFileInput();
      };
    });
  </script>
</body>
</html> 