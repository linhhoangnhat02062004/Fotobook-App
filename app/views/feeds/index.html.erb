<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fotobook - Feeds</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <%= csrf_meta_tags %>
</head>
<body>
  <!-- Navigation -->
  <%= render 'shared/navigation' %>

  <!-- Modern Feeds Page -->
<div class="container-fluid py-4">
  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8 mx-auto">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class = "mt-3">
          <h2 class="fw-bold text-dark mb-1">
            <i class="fas fa-home me-1 text-primary"></i> <span style = "font-size: 19.5pt;">Feeds</span>
          </h2>
          <p class="text-muted mb-0" style = "font-size: 11.5pt;">Discover amazing photos and albums from people you follow</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="btn-group" role="group" aria-label="Feed tabs">
          <input type="radio" class="btn-check" name="feedType" id="photos" checked>
          <label class="btn btn-outline-primary" for="photos">
            <i class="fas fa-image me-1"></i> <span style = "font-size: 11.5pt;">Photos </span>
          </label>
          
          <input type="radio" class="btn-check" name="feedType" id="albums">
          <label class="btn btn-outline-primary" for="albums">
            <i class="fas fa-images me-1"></i> <span style = "font-size: 11.5pt;">Albums</span>
          </label>
        </div>
      </div>

      <!-- Photos Feed -->
      <div id="photosFeed" class="feed-content">
        <% @photos.each do |photo| %>
          <div class="card mb-4 feed-card">
            <!-- Photo Header -->
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-3">
                  <% if photo.user.avatar.present? %>
                    <%= image_tag photo.user.avatar.url, 
                        class: 'rounded-circle', 
                        width: 48, 
                        height: 48,
                        style: 'object-fit: cover;' %>
                  <% else %>
                    <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 48px; height: 48px; background: var(--primary-color);">
                      <i class="fas fa-user text-white"></i>
                    </div>
                  <% end %>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center">
                    <h6 class="mb-0 fw-bold">
                      <%= link_to "#{photo.user.first_name} #{photo.user.last_name}", 
                          user_path(photo.user), 
                          class: 'text-decoration-none text-dark' %>
                    </h6>
                    <% if photo.sharing_mode == 'private' %>
                      <i class="fas fa-lock text-muted ms-2" title="Private"></i>
                    <% end %>
                  </div>
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    <%= time_ago_in_words(photo.created_at) %> ago
                  </small>
                </div>
                <div class="dropdown">
                  <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="<%= photo_path(photo) %>">View Details</a></li>
                    <% if user_signed_in? && current_user == photo.user %>
                      <li><a class="dropdown-item" href="<%= edit_photo_path(photo) %>">Edit</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to 'Delete', photo_path(photo), 
                            method: :delete, 
                            class: 'dropdown-item text-danger',
                            data: { confirm: 'Are you sure?' } %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Photo Content -->
            <div class="card-body p-0">
              <div class="photo-container position-relative">
                <% if photo.image.present? %>
                  <%= image_tag photo.image.url, 
                      class: 'w-100', 
                      style: 'max-height: 600px; object-fit: cover;',
                      data: { 
                        bs_toggle: 'modal', 
                        bs_target: '#photoModal',
                        photo_id: photo.id 
                      } %>
                <% else %>
                  <div class="placeholder-image d-flex align-items-center justify-content-center"
                       style="height: 400px; background: #f8f9fa;">
                    <i class="fas fa-image fa-3x text-muted"></i>
                  </div>
                <% end %>
                
                <!-- Like Button Overlay -->
                <% if user_signed_in? %>
                  <div class="position-absolute top-0 end-0 m-3">
                    <button class="btn btn-light btn-sm rounded-circle like-btn" 
                            data-photo-id="<%= photo.id %>"
                            style="width: 40px; height: 40px;">
                      <i class="fas fa-heart text-danger"></i>
                    </button>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Photo Footer -->
            <div class="card-footer bg-transparent border-0 pt-3">
              <h5 class="fw-bold mb-2"><%= photo.title %></h5>
              <p class="text-muted mb-3"><%= photo.description %></p>
              
              <!-- Interaction Stats -->
              <div class="d-flex align-items-center text-muted">
                <small class="me-3">
                  <i class="fas fa-heart me-1"></i>
                  <span class="like-count">0</span> likes
                </small>
                <small>
                  <i class="fas fa-comment me-1"></i>
                  <span>0</span> comments
                </small>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Albums Feed -->
      <div id="albumsFeed" class="feed-content" style="display: none;">
        <% @albums.each do |album| %>
          <div class="card mb-4 feed-card">
            <!-- Album Header -->
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-3">
                  <% if album.user.avatar.present? %>
                    <%= image_tag album.user.avatar.url, 
                        class: 'rounded-circle', 
                        width: 48, 
                        height: 48,
                        style: 'object-fit: cover;' %>
                  <% else %>
                    <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 48px; height: 48px; background: var(--primary-color);">
                      <i class="fas fa-user text-white"></i>
                    </div>
                  <% end %>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center">
                    <h6 class="mb-0 fw-bold">
                      <%= link_to "#{album.user.first_name} #{album.user.last_name}", 
                          user_path(album.user), 
                          class: 'text-decoration-none text-dark' %>
                    </h6>
                    <% if album.sharing_mode == 'private' %>
                      <i class="fas fa-lock text-muted ms-2" title="Private"></i>
                    <% end %>
                  </div>
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    <%= time_ago_in_words(album.created_at) %> ago
                  </small>
                </div>
                <div class="dropdown">
                  <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="<%= album_path(album) %>">View Album</a></li>
                    <% if user_signed_in? && current_user == album.user %>
                      <li><a class="dropdown-item" href="<%= edit_album_path(album) %>">Edit</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to 'Delete', album_path(album), 
                            method: :delete, 
                            class: 'dropdown-item text-danger',
                            data: { confirm: 'Are you sure?' } %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Album Content -->
            <div class="card-body p-0">
              <div class="album-preview position-relative">
                <% if album.photos.any? %>
                  <div class="row g-0">
                    <% album.photos.limit(4).each_with_index do |photo, index| %>
                      <div class="col-6">
                        <% if photo.image.present? %>
                          <%= image_tag photo.image.url, 
                              class: 'w-100', 
                              style: 'height: 200px; object-fit: cover;' %>
                        <% else %>
                          <div class="placeholder-image d-flex align-items-center justify-content-center"
                               style="height: 200px; background: #f8f9fa;">
                            <i class="fas fa-image text-muted"></i>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                  
                  <!-- Album Overlay -->
                  <div class="album-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                       style="background: rgba(0,0,0,0.5);">
                    <div class="text-center text-white">
                      <h4 class="mb-2"><%= album.title %></h4>
                      <p class="mb-3"><%= album.description %></p>
                      <div class="d-flex align-items-center justify-content-center">
                        <span class="me-3">
                          <i class="fas fa-images me-1"></i>
                          <%= album.photos.count %> photos
                        </span>
                        <span>
                          <i class="fas fa-heart me-1"></i>
                          <span class="like-count">0</span> likes
                        </span>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <div class="placeholder-album d-flex align-items-center justify-content-center"
                       style="height: 300px; background: #f8f9fa;">
                    <div class="text-center">
                      <i class="fas fa-images fa-3x text-muted mb-3"></i>
                      <p class="text-muted">No photos in this album</p>
                    </div>
                  </div>
                <% end %>
                
                <!-- Like Button Overlay -->
                <% if user_signed_in? %>
                  <div class="position-absolute top-0 end-0 m-3">
                    <button class="btn btn-light btn-sm rounded-circle like-btn" 
                            data-album-id="<%= album.id %>"
                            style="width: 40px; height: 40px;">
                      <i class="fas fa-heart text-danger"></i>
                    </button>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Album Footer -->
            <div class="card-footer bg-transparent border-0 pt-3">
              <h5 class="fw-bold mb-2"><%= album.title %></h5>
              <p class="text-muted mb-3"><%= album.description %></p>
              
              <!-- Interaction Stats -->
              <div class="d-flex align-items-center text-muted">
                <small class="me-3">
                  <i class="fas fa-images me-1"></i>
                  <%= album.photos.count %> photos
                </small>
                <small class="me-3">
                  <i class="fas fa-heart me-1"></i>
                  <span class="like-count">0</span> likes
                </small>
                <small>
                  <i class="fas fa-comment me-1"></i>
                  <span>0</span> comments
                </small>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Empty State -->
      <% if @photos.empty? && @albums.empty? %>
        <div class="text-center py-5">
          <div class="empty-state">
            <i class="fas fa-camera fa-4x text-muted mb-4"></i>
            <h4 class="text-muted mb-3">No content to show</h4>
            <p class="text-muted mb-4">Start following people to see their photos and albums in your feed</p>
            <a href="<%= discover_path %>" class="btn btn-primary">
              <i class="fas fa-compass me-2"></i>Discover People
            </a>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="modalPhotoContent"></div>
      </div>
    </div>
  </div>
</div>
